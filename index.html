<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>광합성 실험</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --panel-bg: rgba(255,255,255,0.4);
      --panel-title-size: 1.2rem;
      --panel-text-size: 1.2rem;
      --panel-neon:
        0 0 2px rgba(255,255,255,1),
        0 0 6px rgba(255,255,255,1),
        0 0 12px rgba(255,255,255,0.9),
        0 0 18px rgba(255,255,255,0.8);
    }

    html, body {
      margin:0; padding:0;
      width:100%; height:100%;
      overflow:hidden;
    }

    @font-face {
      font-family: 'NanumSquareRound';
      src: url('NanumSquareRoundEB.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
    }
    body {
      font-family: 'NanumSquareRound', system-ui, sans-serif;
    }

    /* 1920×1080 고정, 배경 */
    #root {
      position:absolute;
      width:1920px; height:1080px;
      transform-origin: top left;
      background:url('슬라이드7.png') no-repeat 0 0;
      background-size:1920px 1080px;
    }

    /* 공통 패널 */
/* 공통 패널 기본 글자 크기 */
  .ctrl-box {
    position:absolute;
    background:var(--panel-bg);
    border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.15);
    z-index:1000;
    font-family:inherit;
    font-size: var(--panel-text-size);  /* ✅ 여기 추가 */
  }

  /* 패널 제목은 여기서만 키움 */
  .ctrl-box .panel-title {
    font-size: var(--panel-title-size); /* 1.05rem */
    font-weight:700;
    margin-bottom:6px;
    text-shadow:var(--panel-neon);
  }

    .panel-title {
      font-size:var(--panel-title-size);
      font-weight:700;
      margin-bottom:6px;
      text-shadow:var(--panel-neon);
    }
    .panel-text {
      font-size:var(--panel-text-size);
      text-shadow:var(--panel-neon);
    }
    .panel-check {
      display:block;
      margin:4px 0 8px;
      font-size:1rem;
      font-weight:600;
      color:#000;
      text-shadow:var(--panel-neon);
    }

    /* CO₂ 박스 */
    #co2-panel {
      top:250px;
      left:10px;
      width:205px;
      height:180px;
      padding:12px 16px;
    }
    #co2-panel p {
      margin:0 0 6px;
    }
    #valve-wrap {
      position:absolute;
      top:80px; left:30px;
      width:120px; height:120px;
      cursor:grab;
      transform-origin:center center;
    }
    #valve-wrap.disabled { cursor:not-allowed; pointer-events:none; opacity:.55; }
    #valve-img {
      position:absolute; inset:0;
      width:100%; height:100%; object-fit:contain;
      transform-origin:50% 50%;
    }

    /* 빛 박스 */
    #light-panel {
      position:absolute;
      top:30px; 
      left:280px;
      width:360px;
      height:90px;
      padding:10px 16px 12px;
      background:var(--panel-bg);
    }
    #light-panel .row {
      display:flex;
      align-items:center;
      gap:20px;
    }
    #light-slider {
      -webkit-appearance: none;
      width: 330px;
      height: 8px;
      background: linear-gradient(90deg,#ffeb3b 100%, #ddd 0);
      border-radius: 4px;
      cursor: pointer;
    }
    #light-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px; height: 16px;
      background: #ffc400;
      border-radius: 50%;
    }
    #light-slider::-moz-range-thumb {
      width: 16px; height: 16px;
      background: #ffc400;
      border-radius: 50%;
      border: none;
    }

    /* 온도 박스 */
    #temp-panel {
      position:absolute;
      top:300px; left:480px;
      width:145px; height:370px;
      padding:12px 16px;
      background:rgba(255,255,255,0.4);
    }
    #temp-slider {
      writing-mode: vertical-lr;
      direction: rtl;
      width: 10px;
      height: 280px;
      accent-color: #ff1e1e;
      cursor: pointer;
    }

    /* 빛 효과 이미지 */
    #light-img {
      position:absolute;
      top:0; left:12.5%;
      width:20%; height:70%;
      object-fit:cover;
      pointer-events:none;
      opacity:1;
      z-index:1;
    }

    /* 식물 + 거품 */
    #left-panel { position:absolute; top:20%; left:5%; width:20%; height:60%; }
    #bubble-container { position:absolute; inset:0; pointer-events:none; }
    .bubble {
      position:absolute;
      bottom:30px;
      background:rgba(255,255,255,0.6);
      border-radius:50%;
      opacity:0.8;
      animation: riseBubble 3s linear forwards;
      pointer-events:none;
    }
    @keyframes riseBubble {
      0% { transform:translateY(0) scale(.5); opacity:.8; }
      100% { transform:translateY(-200px) scale(1.2); opacity:0; }
    }

    /* 주사기 + 공용 측정 버튼 */
    #syringe-wrapper { position:absolute; top:20%; left:10%; width:75%; height:70%; }
    #cylinder-base   { position:absolute; bottom:20%; left:32%; width:10%; height:80%; }
    #piston          { position:absolute; bottom:20%; left:32%; width:10%; height:80%; transition: bottom .1s ease-out; }
    #main-measure {
      position:absolute;
      bottom:12%;
      left:30%;
      width:16%;
      padding:8px 0;
      border:none;
      border-radius:10px;
      background:#0066cc;
      color:#fff;
      font-size:2rem;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.2);
    }
    #main-measure:disabled {
      background:#93b6d5;
      cursor:not-allowed;
    }

    /* 차트 */
    #chart-wrapper {
      position:absolute; top:24%; left:39%;
      width:900px; height:500px;
    }
    #chart-wrapper canvas { width:100% !important; height:100% !important; }
    #indicator {
      position:absolute; bottom:50px; left:55px; width:92%; pointer-events:none;
    }

    /* 동적 제목 */
    #chart-title {
      position:absolute;
      top:16%;
      left:39%;
      width:900px;
      text-align:center;
      font-size:4rem;
      font-weight:700;
      color:#e7ffbf;
      text-shadow:0 1px 3px rgb(35, 41, 32);
      pointer-events:none;
      font-family:inherit;
    }

    /* 실험 버튼 */
    #experiment-toolbar {
      position:absolute;
      top:77%; left:59%;
      display:flex; gap:10px;
      z-index:1500;
    }
    .btn {
      padding:8px 14px;
      border:none;
      border-radius:8px;
      background:#2196f3;
      color:#fff;
      cursor:pointer;
      box-shadow:0 2px 4px rgba(0,0,0,.15);
      font-size:2rem;
      font-family:inherit;
    }
    .btn:disabled { background:#b0bec5; cursor:not-allowed; }
    .btn.secondary { background:#607d8b; }
    .btn.secondary:disabled { background:#b0bec5; }


  </style>
</head>
<body>
  <div id="root">
    <!-- 빛 효과 이미지 -->
    <img id="light-img" src="light.png" alt="light">

    <!-- CO₂ 패널 -->
    <div id="co2-panel" class="ctrl-box">
      <p class="panel-title">이산화 탄소 농도: <b><span id="co2-text" class="panel-text">0.03%</span></b></p>
      <label class="panel-check">
        <input type="checkbox" class="target-check" data-factor="co2"> 이 항목만 측정
      </label>
      <div id="valve-wrap">
        <img id="valve-img" src="valve.png" alt="Valve">
      </div>
    </div>

    <!-- 빛 패널 -->
    <div id="light-panel" class="ctrl-box">
      <div class="panel-title">빛의 세기: <span id="light-val">100</span>%</div>
      <label class="panel-check">
        <input type="checkbox" class="target-check" data-factor="light"> 이 항목만 측정
      </label>
      <div class="row">
        <input type="range" id="light-slider" min="0" max="100" step="1" value="100">
      </div>
    </div>

    <!-- 온도 패널 -->
    <div id="temp-panel" class="ctrl-box">
      <div class="panel-title">온도: <span id="temp-val">25</span>℃</div>
      <label class="panel-check">
        <input type="checkbox" class="target-check" data-factor="temp" id="temp-default"> 이 항목만 측정
      </label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="range" id="temp-slider" min="10" max="45" step="1" value="25">
      </div>
    </div>

    <!-- 실험 시작 / 다시하기 -->
    <div id="experiment-toolbar">
      <button id="start-btn" class="btn">실험 시작</button>
      <button id="reset-btn" class="btn secondary" disabled>다시하기</button>
      <div style="align-self:center; font-size:1.2rem; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.3);">
        현재 광합성량: <span id="current-rate">0</span>%
      </div>
    </div>

    <!-- 왼쪽: 식물 + 거품 -->
    <div id="left-panel">
      <div id="bubble-container"></div>
    </div>

    <!-- 가운데: 주사기 + 공용 측정 버튼 -->
    <div id="syringe-wrapper">
      <img id="cylinder-base" src="cylinder_base.png" alt="Cylinder Base">
      <img id="piston" src="piston.png" alt="Piston">
      <button id="main-measure" disabled>측정</button>
    </div>

    <!-- 오른쪽: 차트 -->
    <div id="chart-title">온도에 따른 광합성량</div>
    <div id="chart-wrapper">
      <canvas id="graph"></canvas>
      <input type="range" id="indicator" min="0" max="100" value="100">
    </div>
  </div>

  <script>
    /* ===== 1. 스케일 ===== */
    function fitRoot() {
      const root = document.getElementById('root');
      const scale = Math.min(window.innerWidth/1920, window.innerHeight/1080);
      root.style.transform = `scale(${scale})`;
    }
    window.addEventListener('load', fitRoot);
    window.addEventListener('resize', fitRoot);

    /* ===== 2. 상태 ===== */
    let running = false;
    let currentTarget = null; // 'light' | 'temp' | 'co2'

    // 현재 값
    let L = 100;
    let T = 25;
    let C = 300;  // ppm

    // CO2 밸브용
    let isDragging = false;
    let startAngle  = 0;
    let currentAngle = (C / 2000) * Math.PI * 2;

    // DOM
    const lightImg      = document.getElementById('light-img');
    const lightSlider   = document.getElementById('light-slider');
    const lightValSpan  = document.getElementById('light-val');

    const tempSlider    = document.getElementById('temp-slider');
    const tempValSpan   = document.getElementById('temp-val');

    const co2PanelTxt   = document.getElementById('co2-text');
    const valveWrap     = document.getElementById('valve-wrap');
    const valveImg      = document.getElementById('valve-img');

    const startBtn      = document.getElementById('start-btn');
    const resetBtn      = document.getElementById('reset-btn');
    const currentRateSpan = document.getElementById('current-rate');
    const indicator     = document.getElementById('indicator');
    const piston        = document.getElementById('piston');
    const checks        = document.querySelectorAll('.target-check');
    const mainMeasure   = document.getElementById('main-measure');
    const chartTitle    = document.getElementById('chart-title');

    let bubbleTimer;

    /* ===== 3. 광합성 함수 ===== */
    function rateLight(I){
      const km = 50;
      const Ieff = Math.min(I, 50);
      return ((100 * Ieff) / (km + Ieff));
    }
    function rateTemp(Tc){
      const optT = 36;
      if (Tc <= optT){
        const norm = (Tc - 10)/(optT - 10);
        return Math.pow(norm,2)*70 + 10;
      } else {
        return Math.max(0, (45 - Tc)/(45 - optT)*90);
      }
    }
    function rateCo2(ppm){
      const c = Math.min(ppm, 1000);
      return ((100 * c) / (300 + c));
    }

    const REF_LIGHT = rateLight(100);
    const REF_TEMP  = rateTemp(36);
    const REF_CO2   = rateCo2(1000);
    const REF_PRODUCT = REF_LIGHT * REF_TEMP * REF_CO2;

    function combinedRatePercent(l,t,c){
      const p = rateLight(l) * rateTemp(t) * rateCo2(c);
      return Math.min(100, +((p / REF_PRODUCT) * 100).toFixed(2));
    }

    /* ===== 4. 버블 & 피스톤 ===== */
    function applyRate(rate){
      piston.style.bottom = (rate/2 + 30) + '%';
      const freq = Math.max(100, 1500 - rate*35);
      clearInterval(bubbleTimer);
      bubbleTimer = setInterval(createBubble, freq);
    }
    function createBubble(){
      const wrap = document.getElementById('bubble-container');
      const b = document.createElement('div');
      const size = 20 + Math.random()*12;
      b.className = 'bubble';
      b.style.width = size + 'px';
      b.style.height= size + 'px';
      b.style.left  = (64 + Math.random()*30) + '%';
      wrap.appendChild(b);
      setTimeout(()=> wrap.removeChild(b), 3000);
    }

    /* ===== 5. Chart ===== */
    const ctx = document.getElementById('graph').getContext('2d');
    const scatter = new Chart(ctx, {
      type:'scatter',
      data:{ datasets:[{
        label:'측정값',
        data:[],
        showLine:true,
        tension:0.4,
        borderColor:'red',
        borderWidth:2,
        pointBackgroundColor:'green',
        pointRadius:6
      }]},
      options:{
        responsive:false,
        maintainAspectRatio:false,
        scales:{
          x:{ title:{display:true, text:'실험 변인'}, min:0, max:100 },
          y:{ title:{display:true, text:'광합성량(%)'}, min:0, max:100 }
        },
        plugins:{ legend:{display:false} }
      }
    });

    function setXAxisFor(target){
      const x = scatter.options.scales.x;
      if (target === 'light'){
        x.title.text = '빛의 세기(%)';
        x.min = 0; x.max = 100;
        indicator.min = 0; indicator.max = 100; indicator.value = L;
      } else if (target === 'temp'){
        x.title.text = '온도(℃)';
        x.min = 10; x.max = 45;
        indicator.min = 10; indicator.max = 45; indicator.value = T;
      } else {
        x.title.text = '이산화 탄소 농도 (ppm)';
        x.min = 0; x.max = 2000;
        indicator.min = 0; indicator.max = 2000; indicator.value = C;
      }
      scatter.update();
    }

    function updateChartTitle(){
      let txt = '';
      if (currentTarget === 'light') txt = '빛의 세기에 따른 광합성량';
      else if (currentTarget === 'temp') txt = '온도에 따른 광합성량';
      else if (currentTarget === 'co2') txt = '이산화 탄소 농도에 따른 광합성량';
      else txt = '광합성량';
      chartTitle.textContent = txt;
    }

    /* ===== 6. 체크박스: 하나만, 자기 자신으로 해제 안 됨 ===== */
    function updateTarget(changed){
      // 자기 자신을 눌러도 해제되지 않도록 무조건 true로 유지
      changed.checked = true;
      checks.forEach(c => {
        if (c !== changed) c.checked = false;
      });
      currentTarget = changed.dataset.factor;
      startBtn.disabled = !currentTarget || running;
      if (currentTarget) {
        setXAxisFor(currentTarget);
        updateChartTitle();
      }
      updatePreview();
    }
    checks.forEach(c => {
      c.addEventListener('change', () => {
        if (running) return;
        updateTarget(c);
      });
    });

    /* ===== 7. 인터랙션 on/off ===== */
    function setInteractivity(){
      if (!running){
        lightSlider.disabled = false;
        tempSlider.disabled  = false;
        valveWrap.classList.remove('disabled');
        mainMeasure.disabled = true;
      } else {
        lightSlider.disabled = (currentTarget !== 'light');
        tempSlider.disabled  = (currentTarget !== 'temp');
        if (currentTarget === 'co2') valveWrap.classList.remove('disabled');
        else valveWrap.classList.add('disabled');
        mainMeasure.disabled = false;
      }
    }

    /* ===== 8. 프리뷰 ===== */
    function updateLightSliderFill(){
      const pct = L;
      lightSlider.style.background = `linear-gradient(90deg, #ffeb3b 0%, #ffeb3b ${pct}%, #ddd ${pct}%, #ddd 100%)`;
    }

    function updatePreview(){
      lightImg.style.opacity = L/100;
      co2PanelTxt.textContent = (C/10000).toFixed(2) + '%';
      const r = combinedRatePercent(L, T, C);
      currentRateSpan.textContent = r.toFixed(2);
      applyRate(r);
      if (currentTarget === 'light') indicator.value = L;
      else if (currentTarget === 'temp') indicator.value = T;
      else if (currentTarget === 'co2') indicator.value = C;
      updateLightSliderFill();
    }

    /* ===== 9. 슬라이더 이벤트 ===== */
    lightSlider.addEventListener('input', () => {
      L = parseInt(lightSlider.value,10);
      lightValSpan.textContent = L;
      updateLightSliderFill();
      if (!running || currentTarget === 'light') updatePreview();
    });
    tempSlider.addEventListener('input', () => {
      T = parseInt(tempSlider.value,10);
      tempValSpan.textContent = T;
      if (!running || currentTarget === 'temp') updatePreview();
    });

    /* ===== 10. CO2 밸브 드래그 ===== */
    function angleFrom(e, rect){
      return Math.atan2(e.clientY - (rect.top + rect.height/2), e.clientX - (rect.left + rect.width/2));
    }
    valveWrap.addEventListener('pointerdown', e => {
      if (running && currentTarget !== 'co2') return;
      e.preventDefault();
      const r = valveWrap.getBoundingClientRect();
      startAngle = angleFrom(e, r);
      isDragging = true;
      valveWrap.setPointerCapture(e.pointerId);
    });
    valveWrap.addEventListener('pointermove', e => {
      if (!isDragging) return;
      const r = valveWrap.getBoundingClientRect();
      let newA = angleFrom(e, r);
      let delta = newA - startAngle;
      if (delta > Math.PI) delta -= 2*Math.PI;
      else if (delta < -Math.PI) delta += 2*Math.PI;

      let nextAngle = currentAngle + delta * 0.5;
      const TWO_PI = Math.PI*2;
      if (nextAngle < 0) nextAngle = 0;
      if (nextAngle > TWO_PI) nextAngle = TWO_PI;

      currentAngle = nextAngle;
      startAngle   = newA;

      valveImg.style.transform = `rotate(${currentAngle*180/Math.PI}deg)`;

      C = Math.round((currentAngle / TWO_PI) * 2000);
      if (!running || currentTarget === 'co2') updatePreview();
    });
    valveWrap.addEventListener('pointerup', e => {
      if (!isDragging) return;
      isDragging = false;
      valveWrap.releasePointerCapture(e.pointerId);
    });

    /* ===== 11. 실험 시작 / 다시하기 ===== */
    startBtn.addEventListener('click', () => {
      if (!currentTarget) return;
      running = true;
      startBtn.disabled = true;
      resetBtn.disabled = false;
      checks.forEach(c => c.disabled = true);
      setInteractivity();
      
    });
    resetBtn.addEventListener('click', () => {
      running = false;

      // 1) 체크박스 다시 살리고
      checks.forEach(c => { c.disabled = false; c.checked = false; });

      // 2) 온도를 기본으로 다시 선택
      const tempCheck = document.getElementById('temp-default');
      tempCheck.checked = true;
      updateTarget(tempCheck);   // ← 여기서 currentTarget을 'temp'로 다시 잡아줌

      // 3) 버튼 상태
      startBtn.disabled = false; // 온도 선택돼 있으니까 시작 가능
      resetBtn.disabled = true;  // 막 리셋했으니 다시하기는 잠깐 꺼둠

      // 4) 그래프 비우기
      scatter.data.datasets[0].data = [];
      scatter.update();

      setInteractivity();
      updatePreview();
    });

        /* ===== 12. 공용 측정 버튼 ===== */
    function doMeasure(){
      if (!running || !currentTarget) return;
      const r = combinedRatePercent(L, T, C);
      let xVal = 0;
      if (currentTarget === 'light') xVal = L;
      else if (currentTarget === 'temp') xVal = T;
      else xVal = C;

      const data = scatter.data.datasets[0].data;
      const idx = data.findIndex(p => p.x === xVal);
      const pt = { x:xVal, y:r };
      if (idx >= 0) data[idx] = pt;
      else {
        const ins = data.findIndex(p => p.x > xVal);
        if (ins === -1) data.push(pt); else data.splice(ins,0,pt);
      }
      scatter.update();
    }
    mainMeasure.addEventListener('click', doMeasure);

    /* ===== 13. 초기 ===== */
    window.addEventListener('load', () => {
      valveImg.style.transform = `rotate(${currentAngle*180/Math.PI}deg)`;
      const tempCheck = document.getElementById('temp-default');
      tempCheck.checked = true;
      updateTarget(tempCheck);  // 기본: 온도
      setInteractivity();
      updatePreview();
    });
  </script>
</body>
</html>
