<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í†µí•© ê´‘í•©ì„± ì‹¤í—˜ (ìœ„ì¹˜ ì¡´ì¤‘ ë²„ì „)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body {
      margin:0; padding:0;
      width:100%; height:100%;
      overflow:hidden;
    }
    /* 1920Ã—1080 ê³ ì •, ì˜¨ë„ ë°°ê²½ */
    #root {
      position:absolute;
      width:1920px; height:1080px;
      transform-origin: top left;
      background:url('ìŠ¬ë¼ì´ë“œ7.PNG') no-repeat 0 0;
      background-size:1920px 1080px;
    }

    /* ê³µí†µ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .ctrl-box {
      position:absolute;
      background:rgba(255,255,255,0.9);
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
      font-family:system-ui, sans-serif;
      z-index:1000;
    }

    /* â–¶ 1) COâ‚‚ ë°•ìŠ¤: ë„¤ê°€ ì°ì€ ìŠ¤ìƒ· ìœ„ì¹˜ */
    #co2-panel {
      top:250px;
      left:10px;
      width:185px;
      height:260px;
      padding:12px 16px;
    }
    #co2-panel p {
      margin:0 0 6px;
      font-size:1.05rem;
    }
    #valve-wrap {
      position:absolute;
      top:80px; left:30px;
      width:120px; height:120px;
      cursor:grab;
      transform-origin:center center;
    }
    #valve-wrap.disabled { cursor:not-allowed; pointer-events:none; opacity:.55; }
    #valve-img {
      position:absolute; inset:0;
      width:100%; height:100%; object-fit:contain;
      transform-origin:50% 50%;
    }
    #co2-measure {
      position:absolute;
      bottom:16px; left:27px;
      padding:6px 20px;
      background:#2196f3; color:#fff;
      border:none; border-radius:6px;
      font-size:1rem;
      cursor:pointer;
    }
    #co2-measure:disabled { background:#b0bec5; cursor:not-allowed; }

    /* â–¶ 2) ë¹› ë°•ìŠ¤: ì²« ì½”ë“œ ìœ„ì¹˜ */
    #light-panel {
      position:absolute;
      top:50px; 
      left:480px;
      width:180px;              /* â† ê°€ë¡œ ìŠ¬ë¼ì´ë”ë¼ ë°•ìŠ¤ í­ì„ ì¢€ ë„“í˜€ì¤Œ */
      height:130px;             /* â† ì„¸ë¡œë¡œ ê¸¸ë˜ ê±° ì¤„ì´ê¸° */
      padding:12px 16px;
      background:rgba(255,255,255,0.9);
    }

    #light-panel .row {
      display:flex;
      align-items:center;
      gap:10px;
    }

    /* ğŸ” ë¹› ìŠ¬ë¼ì´ë”: ê°€ë¡œí˜•ìœ¼ë¡œ */
    #light-slider {
      -webkit-appearance: none; /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° */
      width: 120px;             /* â† ì›í•˜ëŠ” ê¸¸ì´ */
      height: 6px;
      background: #ddd;
      border-radius: 4px;
      cursor: pointer;
    }
    #light-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px; height: 14px;
      background: #2196f3;
      border-radius: 50%;
    }
    #light-slider::-moz-range-thumb {
      width: 14px; height: 14px;
      background: #2196f3;
      border-radius: 50%;
      border: none;
    }

    /* â–¶ 3) ì˜¨ë„ ë°•ìŠ¤: ë‘ ë²ˆì§¸ ì½”ë“œ ìœ„ì¹˜ */
    #temp-panel {
      position:absolute;
      top:300px; left:480px;
      width:100px; height:370px;
      padding:12px 16px;
      background:rgba(255,255,255,0.4);
    }
    #temp-slider {
      -webkit-appearance: slider-vertical;
      accent-color:#f44336;
      width:10px; height:280px;
      cursor:pointer;
    }
    #temp-measure {
      margin-top:10px; width:100%; padding:6px 0;
      border:none; background:#2196f3; color:#fff;
      border-radius:6px; font-size:1rem;
      cursor:pointer;
    }
    #temp-measure:disabled { background:#b0bec5; cursor:not-allowed; }

    /* ë¹› íš¨ê³¼ ì´ë¯¸ì§€(ì›ë˜ ë¹› ì½”ë“œ ìœ„ì¹˜) */
    #light-img {
      position:absolute;
      top:0; left:12.5%;
      width:20%; height:70%;
      object-fit:cover;
      pointer-events:none;
      opacity:1;
      z-index:1;
    }

    /* ì‹ë¬¼ + ê±°í’ˆ (ì˜¨ë„ ì½”ë“œë‘ ë¹„ìŠ·í•˜ê²Œ) */
    #left-panel { position:absolute; top:20%; left:5%; width:20%; height:60%; }
    #bubble-container { position:absolute; inset:0; pointer-events:none; }
    .bubble {
      position:absolute;
      bottom:30px;
      background:rgba(255,255,255,0.6);
      border-radius:50%;
      opacity:0.8;
      animation: riseBubble 3s linear forwards;
      pointer-events:none;
    }
    @keyframes riseBubble {
      0% { transform:translateY(0) scale(.5); opacity:.8; }
      100% { transform:translateY(-200px) scale(1.2); opacity:0; }
    }

    /* ì£¼ì‚¬ê¸° */
    #syringe-wrapper { position:absolute; top:20%; left:10%; width:75%; height:70%; }
    #cylinder-base   { position:absolute; bottom:20%; left:32%; width:10%; height:80%; }
    #piston          { position:absolute; bottom:20%; left:32%; width:10%; height:80%; transition: bottom .1s ease-out; }

    /* ì°¨íŠ¸ (ì˜¨ë„ ì½”ë“œ ìœ„ì¹˜) */
    #chart-wrapper {
      position:absolute; top:24%; left:39%;
      width:900px; height:500px;
    }
    #chart-wrapper canvas { width:100% !important; height:100% !important; }
    #indicator {
      position:absolute; bottom:50px; left:55px; width:92%; pointer-events:none;
    }

    /* ì‹¤í—˜ ì‹œì‘ / ë‹¤ì‹œí•˜ê¸° â€” ì°¨íŠ¸ ìœ„ìª½ìœ¼ë¡œ ë¹¼ê¸° */
    #experiment-toolbar {
      position:absolute;
      top:77%; left:59%;
      display:flex; gap:10px;
      z-index:1500;
    }
    .btn {
      padding:8px 14px;
      border:none;
      border-radius:8px;
      background:#2196f3;
      color:#fff;
      cursor:pointer;
      box-shadow:0 2px 4px rgba(0,0,0,.15);
      font-size:1rem;
    }
    .btn:disabled { background:#b0bec5; cursor:not-allowed; }
    .btn.secondary { background:#607d8b; }
    .btn.secondary:disabled { background:#b0bec5; }

    /* í™ˆë²„íŠ¼ */
    #home-btn{
      position:fixed; bottom:2.5vh; right:2.5vw;
      width:64px; height:64px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:2rem;
      background:rgba(255,255,255,.85);
      color:#333; text-decoration:none;
      box-shadow:0 4px 8px rgba(0,0,0,.25);
      z-index:2000;
    }
  </style>
</head>
<body>
  <div id="root">
    <!-- ë¹› íš¨ê³¼ ì´ë¯¸ì§€ (ë¹› ìŠ¬ë¼ì´ë”ì™€ ì—°ë™) -->
    <img id="light-img" src="light.png" alt="light">

    <!-- â–¶ COâ‚‚ ë°•ìŠ¤ (ì›ë˜ ìë¦¬) -->
    <div id="co2-panel" class="ctrl-box">
      <p>í˜„ì¬ ì´ì‚°í™” íƒ„ì†Œ ë†ë„: <b><span id="co2-text">0.03%</span></b></p>
      <label style="font-size:.8rem; display:block; margin-bottom:4px;">
        <input type="checkbox" class="target-check" data-factor="co2"> ì´ í•­ëª© ë³€í™”
      </label>
      <div id="valve-wrap">
        <img id="valve-img" src="valve.png" alt="Valve">
      </div>
      <button id="co2-measure" disabled>ì¸¡ì •</button>
    </div>

    <div id="light-panel" class="ctrl-box">
      <label for="light-slider">ë¹› ì„¸ê¸°</label>
      <label style="font-size:.8rem; display:block; margin-bottom:4px;">
        <input type="checkbox" class="target-check" data-factor="light"> ì´ í•­ëª© ë³€í™”
      </label>

      <!-- ê°€ë¡œ ë ˆì´ì•„ì›ƒ -->
      <div class="row">
        <input type="range" id="light-slider" min="0" max="100" step="1" value="100">
        <span><span id="light-val">100</span>%</span>
      </div>

      <button id="light-measure" disabled>ì¸¡ì •</button>
    </div>


    <!-- â–¶ ì˜¨ë„ ë°•ìŠ¤ (ì›ë˜ ìë¦¬) -->
    <div id="temp-panel" class="ctrl-box">
      <label for="temp-slider">ì˜¨ë„</label>
      <label style="font-size:.8rem; display:block; margin-bottom:4px;">
        <input type="checkbox" class="target-check" data-factor="temp"> ì´ í•­ëª© ë³€í™”
      </label>
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="range" id="temp-slider" min="10" max="45" step="1" value="25">
        <span><span id="temp-val">25</span>â„ƒ</span>
      </div>
      <button id="temp-measure" disabled>ì¸¡ì •</button>
    </div>

    <!-- â–¶ ì‹¤í—˜ ì‹œì‘ / ë‹¤ì‹œí•˜ê¸° (ì˜¤ë¥¸ìª½) -->
    <div id="experiment-toolbar">
      <button id="start-btn" class="btn" disabled>ì‹¤í—˜ ì‹œì‘</button>
      <button id="reset-btn" class="btn secondary" disabled>ë‹¤ì‹œí•˜ê¸°</button>
      <div style="align-self:center; font-size:.8rem; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.3);">
        í˜„ì¬ ê´‘í•©ì„±ëŸ‰: <span id="current-rate">0</span>%
      </div>
    </div>

    <!-- ì™¼ìª½: ì‹ë¬¼ + ê±°í’ˆ -->
    <div id="left-panel">
      <div id="bubble-container"></div>
    </div>

    <!-- ê°€ìš´ë°: ì£¼ì‚¬ê¸° -->
    <div id="syringe-wrapper">
      <img id="cylinder-base" src="cylinder_base.png" alt="Cylinder Base">
      <img id="piston" src="piston.png" alt="Piston">
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì°¨íŠ¸ -->
    <div id="chart-wrapper">
      <canvas id="graph"></canvas>
      <input type="range" id="indicator" min="0" max="100" value="100">
    </div>
  </div>

  <a href="index.html" id="home-btn" title="ë©”ì¸ í™”ë©´ìœ¼ë¡œ">ğŸ </a>

  <script>
    /* ===== 1. ìŠ¤ì¼€ì¼ ===== */
    function fitRoot() {
      const root = document.getElementById('root');
      const scale = Math.min(window.innerWidth/1920, window.innerHeight/1080);
      root.style.transform = `scale(${scale})`;
    }
    window.addEventListener('load', fitRoot);
    window.addEventListener('resize', fitRoot);

    /* ===== 2. ìƒíƒœ ===== */
    let running = false;
    let currentTarget = null; // 'light' | 'temp' | 'co2'

    // í˜„ì¬ ê°’
    let L = 100;
    let T = 25;
    let C = 300;  // ppm

    // CO2 ë°¸ë¸Œìš©
    let isDragging = false;
    let startAngle  = 0;
    let currentAngle = (C / 2000) * Math.PI * 2;

    // DOM
    const lightImg      = document.getElementById('light-img');
    const lightSlider   = document.getElementById('light-slider');
    const lightValSpan  = document.getElementById('light-val');
    const lightMeasure  = document.getElementById('light-measure');

    const tempSlider    = document.getElementById('temp-slider');
    const tempValSpan   = document.getElementById('temp-val');
    const tempMeasure   = document.getElementById('temp-measure');

    const co2PanelTxt   = document.getElementById('co2-text');
    const valveWrap     = document.getElementById('valve-wrap');
    const valveImg      = document.getElementById('valve-img');
    const co2Measure    = document.getElementById('co2-measure');

    const startBtn      = document.getElementById('start-btn');
    const resetBtn      = document.getElementById('reset-btn');
    const currentRateSpan = document.getElementById('current-rate');
    const indicator     = document.getElementById('indicator');
    const piston        = document.getElementById('piston');
    const checks        = document.querySelectorAll('.target-check');

    let bubbleTimer;

    /* ===== 3. ë„¤ê°€ ì“°ë˜ ê³¡ì„  ===== */
    function rateLight(I){
      const km = 50;
      const Ieff = Math.min(I, 50);
      return ((100 * Ieff) / (km + Ieff));
    }
    function rateTemp(Tc){
      const optT = 36;
      if (Tc <= optT){
        const norm = (Tc - 10)/(optT - 10);
        return Math.pow(norm,2)*70 + 10;
      } else {
        return Math.max(0, (45 - Tc)/(45 - optT)*90);
      }
    }
    function rateCo2(ppm){
      const c = Math.min(ppm, 1000);
      return ((100 * c) / (300 + c));
    }

    // ê¸°ì¤€ ìµœëŒ€ ê³±
    const REF_LIGHT = rateLight(100);
    const REF_TEMP  = rateTemp(36);
    const REF_CO2   = rateCo2(1000);
    const REF_PRODUCT = REF_LIGHT * REF_TEMP * REF_CO2;

    function combinedRatePercent(l,t,c){
      const p = rateLight(l) * rateTemp(t) * rateCo2(c);
      return Math.min(100, +((p / REF_PRODUCT) * 100).toFixed(2));
    }

    /* ===== 4. ë²„ë¸” & í”¼ìŠ¤í†¤ ===== */
    function applyRate(rate){
      piston.style.bottom = (rate/2 + 30) + '%';
      const freq = Math.max(100, 1500 - rate*35);
      clearInterval(bubbleTimer);
      bubbleTimer = setInterval(createBubble, freq);
    }
    function createBubble(){
      const wrap = document.getElementById('bubble-container');
      const b = document.createElement('div');
      const size = 20 + Math.random()*12;
      b.className = 'bubble';
      b.style.width = size + 'px';
      b.style.height= size + 'px';
      b.style.left  = (64 + Math.random()*30) + '%';
      wrap.appendChild(b);
      setTimeout(()=> wrap.removeChild(b), 3000);
    }

    /* ===== 5. Chart ===== */
    const ctx = document.getElementById('graph').getContext('2d');
    const scatter = new Chart(ctx, {
      type:'scatter',
      data:{ datasets:[{
        label:'ì¸¡ì •ê°’',
        data:[],
        showLine:true,
        tension:0.4,
        borderColor:'red',
        borderWidth:2,
        pointBackgroundColor:'green',
        pointRadius:6
      }]},
      options:{
        responsive:false,
        maintainAspectRatio:false,
        scales:{
          x:{ title:{display:true, text:'ì‹¤í—˜ ë³€ì¸'}, min:0, max:100 },
          y:{ title:{display:true, text:'ê´‘í•©ì„±ëŸ‰(%)'}, min:0, max:100 }
        },
        plugins:{ legend:{display:false} }
      }
    });
    function setXAxisFor(target){
      const x = scatter.options.scales.x;
      if (target === 'light'){
        x.title.text = 'ë¹› ì„¸ê¸°(%)';
        x.min = 0; x.max = 100;
        indicator.min = 0; indicator.max = 100; indicator.value = L;
      } else if (target === 'temp'){
        x.title.text = 'ì˜¨ë„(â„ƒ)';
        x.min = 10; x.max = 45;
        indicator.min = 10; indicator.max = 45; indicator.value = T;
      } else {
        x.title.text = 'ì´ì‚°í™” íƒ„ì†Œ ë†ë„ (%)';
        x.min = 0; x.max = 2000;
        indicator.min = 0; indicator.max = 2000; indicator.value = C;
      }
      scatter.update();
    }

    /* ===== 6. ì²´í¬ë°•ìŠ¤: í•˜ë‚˜ë§Œ ì„ íƒ ===== */
    function updateTarget(changed){
      checks.forEach(c => {
        if (c !== changed) c.checked = false;
      });
      currentTarget = changed.checked ? changed.dataset.factor : null;
      startBtn.disabled = !currentTarget || running;
      if (currentTarget) setXAxisFor(currentTarget);
      updatePreview();
    }
    checks.forEach(c => {
      c.addEventListener('change', () => {
        if (running) return; // ì‹¤í—˜ì¤‘ì—” íƒ€ê²Ÿ ë³€ê²½ X
        updateTarget(c);
      });
    });

    /* ===== 7. ì¸í„°ë™ì…˜ on/off ===== */
    function setInteractivity(){
      if (!running){
        // ì‹¤í—˜ ì „ : ë‹¤ ì—´ë ¤ìˆìŒ
        lightSlider.disabled = false;
        tempSlider.disabled  = false;
        valveWrap.classList.remove('disabled');

        lightMeasure.disabled = true;
        tempMeasure.disabled  = true;
        co2Measure.disabled   = true;
      } else {
        // ì‹¤í—˜ ì¤‘ : targetë§Œ ì—´ë¦¼
        lightSlider.disabled = (currentTarget !== 'light');
        tempSlider.disabled  = (currentTarget !== 'temp');
        if (currentTarget === 'co2') valveWrap.classList.remove('disabled');
        else valveWrap.classList.add('disabled');

        // ì¸¡ì • ë²„íŠ¼ë„ targetë§Œ
        lightMeasure.disabled = (currentTarget !== 'light');
        tempMeasure.disabled  = (currentTarget !== 'temp');
        co2Measure.disabled   = (currentTarget !== 'co2');
      }
    }

    /* ===== 8. í”„ë¦¬ë·° ===== */
    function updatePreview(){
      // ë¹› íš¨ê³¼
      lightImg.style.opacity = L/100;
      // CO2 í…ìŠ¤íŠ¸(%)ë¡œ
      co2PanelTxt.textContent = (C/10000).toFixed(2) + '%';
      const r = combinedRatePercent(L, T, C);
      currentRateSpan.textContent = r.toFixed(2);
      applyRate(r);
      // indicator
      if (currentTarget === 'light') indicator.value = L;
      else if (currentTarget === 'temp') indicator.value = T;
      else if (currentTarget === 'co2') indicator.value = C;
    }

    /* ===== 9. ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ===== */
    lightSlider.addEventListener('input', () => {
      L = parseInt(lightSlider.value,10);
      lightValSpan.textContent = L;
      if (!running || currentTarget === 'light') updatePreview();
    });
    tempSlider.addEventListener('input', () => {
      T = parseInt(tempSlider.value,10);
      tempValSpan.textContent = T;
      if (!running || currentTarget === 'temp') updatePreview();
    });

    /* ===== 10. CO2 ë°¸ë¸Œ ë“œë˜ê·¸ ===== */
    function angleFrom(e, rect){
      return Math.atan2(e.clientY - (rect.top + rect.height/2), e.clientX - (rect.left + rect.width/2));
    }
    valveWrap.addEventListener('pointerdown', e => {
      if (running && currentTarget !== 'co2') return;
      e.preventDefault();
      const r = valveWrap.getBoundingClientRect();
      startAngle = angleFrom(e, r);
      isDragging = true;
      valveWrap.setPointerCapture(e.pointerId);
    });
    valveWrap.addEventListener('pointermove', e => {
      if (!isDragging) return;
      const r = valveWrap.getBoundingClientRect();
      let newA = angleFrom(e, r);
      let delta = newA - startAngle;
      if (delta > Math.PI) delta -= 2*Math.PI;
      else if (delta < -Math.PI) delta += 2*Math.PI;

      let nextAngle = currentAngle + delta * 0.5;
      const TWO_PI = Math.PI*2;
      if (nextAngle < 0) nextAngle = 0;
      if (nextAngle > TWO_PI) nextAngle = TWO_PI;

      currentAngle = nextAngle;
      startAngle   = newA;

      valveImg.style.transform = `rotate(${currentAngle*180/Math.PI}deg)`;

      // ê°ë„â†’ppm
      C = Math.round((currentAngle / TWO_PI) * 2000);
      if (!running || currentTarget === 'co2') updatePreview();
    });
    valveWrap.addEventListener('pointerup', e => {
      if (!isDragging) return;
      isDragging = false;
      valveWrap.releasePointerCapture(e.pointerId);
    });

    /* ===== 11. ì‹¤í—˜ ì‹œì‘ / ë‹¤ì‹œí•˜ê¸° ===== */
    startBtn.addEventListener('click', () => {
      if (!currentTarget) return;
      running = true;
      startBtn.disabled = true;
      resetBtn.disabled = false;

      // ì²´í¬ë°•ìŠ¤ ì ê·¸ê¸°
      checks.forEach(c => c.disabled = true);

      setInteractivity();
    });

    resetBtn.addEventListener('click', () => {
      running = false;
      // ì²´í¬ë°•ìŠ¤ í’€ê¸° & ì„ íƒ í•´ì œ
      checks.forEach(c => { c.disabled = false; c.checked = false; });
      currentTarget = null;

      startBtn.disabled = true;
      resetBtn.disabled = true;

      // ê·¸ë˜í”„ ë¹„ìš°ê¸°
      scatter.data.datasets[0].data = [];
      scatter.update();

      setInteractivity();
      setXAxisFor('light'); // ê¸°ë³¸ ì¶•
      updatePreview();
    });

    /* ===== 12. ì¸¡ì • ë²„íŠ¼ë“¤ ===== */
    function doMeasure(){
      if (!running || !currentTarget) return;
      const r = combinedRatePercent(L, T, C);
      let xVal = 0;
      if (currentTarget === 'light') xVal = L;
      else if (currentTarget === 'temp') xVal = T;
      else xVal = C;

      const data = scatter.data.datasets[0].data;
      const idx = data.findIndex(p => p.x === xVal);
      const pt = { x:xVal, y:r };
      if (idx >= 0) data[idx] = pt;
      else {
        const ins = data.findIndex(p => p.x > xVal);
        if (ins === -1) data.push(pt); else data.splice(ins,0,pt);
      }
      scatter.update();
    }
    lightMeasure.addEventListener('click', doMeasure);
    tempMeasure.addEventListener('click', doMeasure);
    co2Measure.addEventListener('click', doMeasure);

    /* ===== 13. ì´ˆê¸° ===== */
    window.addEventListener('load', () => {
      // ë°¸ë¸Œ ì´ˆê¸° íšŒì „ ë°˜ì˜
      valveImg.style.transform = `rotate(${currentAngle*180/Math.PI}deg)`;
      setInteractivity();
      updatePreview();
    });
  </script>
</body>
</html>
